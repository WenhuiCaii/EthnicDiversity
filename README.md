# Ethnic Diversity

This repository provides code availability for the paper "Landscape of multiculturalism in Australia: tracking ethnic diversity and its relation with neighbourhood features in 2001-2021". In this paper, we utilized the random forest model to explore associations of demographic, socioeconomic and housing features on ethnic diversity. All features were fully explained in the Method section and data from 2001 was uploaded as an example here: [Regression data 2001](https://github.com/WenhuiCaii/EthnicDiversity/blob/main/regression_2001.csv)

# SHapley Additive exPlanations (SHAP)

To further explain random forest models developed in this study, we conducted a SHapley Additive exPlanations (SHAP) analysis to realize the local interpretable model-agnostic explanation and to ease the interpretation. Two functions in the [SHAP](https://github.com/slundberg/shap) package were applied to modelling results:

A general plot for the overview of which features are most important for a model with the SHAP values of every feature for every sample, generated by `shap.summary_plot`:

```bash
shap.summary_plot(shap_values, plot_type='violin', show=False)
```

An interactive dependence plot to visualize the local impact of independent variables on ethnic diversity, generated by `shap.dependence_plot`

```bash
shap.dependence_plot('Female_01', shap_values.values, x_test, cmap=plt.get_cmap("magma"),alpha=0.5,dot_size=5,interaction_index='Publictransit_01')
```
![image](https://github.com/WenhuiCaii/EthnicDiversity/blob/fig_example/ID_2001_MeanSHAP.jpg)

To reveal global interaction patterns, the feature with the upmost feature importance was chosen as an interactive feature. In addition, we adopted a regression line to depict the average marginal effect of the target feature, generated by `sm.nonparametric.lowess`:

```bash
for a in features:
    idx = np.where(x_test.columns==a)[0][0]
    X = x_test.iloc[:,idx]
    y_sv = shap_values.values[:,idx]
    lowess = sm.nonparametric.lowess(y_sv, X, frac=.3)
    _,ax = plt.subplots()
    ax.plot(*list(zip(*lowess)), color="y", linestyle='-.',)
    shap.dependence_plot(a, shap_values.values, x_test, cmap=plt.get_cmap("RdBu_r"),dot_size=5,interaction_index='Indigenous_01',show=False,ax=ax)
```
> **Note**
> SHAP interaction values are only support when implement Tree SHAP, [see guide here](https://shap.readthedocs.io/en/latest/generated/shap.explainers.Tree.html#:~:text=Tree%20SHAP%20is%20a%20fast,the%20local%20compiled%20C%20extention.)

![image](https://github.com/WenhuiCaii/EthnicDiversity/blob/fig_example/ID_Separateh_01RL.jpg)

The original code: [Random forest with SHAP](https://github.com/WenhuiCaii/EthnicDiversity/blob/main/2001.ipynb)
